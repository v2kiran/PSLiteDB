name: "Deploy"

on:
  push:
    branches:
      - v2.1

jobs:
  job-1-pwsh:
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.1

      - name: Set environment variables
        run: |
          $Username, $ProjectName = $env:GITHUB_REPOSITORY -split "/"
          @(
            "GH_USERNAME={0}" -f $Username
            "GH_PROJECTNAME={0}" -f $ProjectName
          ) | Add-Content -Path $env:GITHUB_ENV
        shell: pwsh


      - name: Run Pester Tests
        run: |
          Import-Module (join-path $env:GITHUB_WORKSPACE -childpath 'module/PSLiteDB.psd1')
          Invoke-Pester -path (join-path $env:GITHUB_WORKSPACE -childpath 'tests/v5.tests.ps1') -pass -Outputfile pester_test_result.xml -OutputFormat NUnitXml
        shell: pwsh

      - name: test module
        id: test_module
        uses: zyborg/pester-tests-report@v1
        with:
          test_results_path: pester_test_result.xml
          report_name: module_tests
          report_title: PSLiteDB Tests
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gist_token: ${{ secrets.GIST_TOKEN }}
          gist_name: testreport
      - name: dump test results
        shell: pwsh
        run: |
            Write-Host 'Total Tests Executed...:  ${{ steps.test_module.outputs.total_count }}'
            Write-Host 'Total Tests PASSED.....:  ${{ steps.test_module.outputs.passed_count }}'
            Write-Host 'Total Tests FAILED.....:  ${{ steps.test_module.outputs.failed_count }}'